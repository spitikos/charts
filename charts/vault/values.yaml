vault:
  ui:
    enabled: true

  server:
    dev:
      enabled: false

    dataStorage:
      enabled: true
      size: 1Gi
      storageClass: "local-path"

    postInstall:
      - command:
          - "/bin/sh"
          - "-c"
          - |
            apk add curl
            # Wait for Vault to be ready
            until curl -s -f http://vault-0.vault-internal:8200/v1/sys/health; do
              echo "Waiting for Vault to be ready...";
              sleep 2;
            done

            # Login with the root token (this will need to be done manually once for unsealing)
            export VAULT_TOKEN=$(cat /vault/file/root-token)

            # 1. Enable Kubernetes Auth Method
            vault auth enable kubernetes

            # 2. Configure Kubernetes Auth Method
            vault write auth/kubernetes/config \
              kubernetes_host="https://kubernetes.default.svc" \
              token_reviewer_jwt=@/var/run/secrets/kubernetes.io/serviceaccount/token \
              kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
              issuer="https://kubernetes.default.svc"

            # 3. Create the API Policy
            vault policy write api - <<EOF
            path "secret/data/spitikos/api" {
              capabilities = ["read"]
            }
            EOF

            # 4. Create the API Role
            vault write auth/kubernetes/role/api \
              bound_service_account_names=api \
              bound_service_account_namespaces=api \
              policies=api \
              ttl=24h

  injector:
    enabled: true

ingress:
  hosts:
    - vault.taehoonlee.cloud
  serviceName: vault-ui
  servicePort: 8200

serviceAccount:
  name: vault-auth
  namespace: kube-system
